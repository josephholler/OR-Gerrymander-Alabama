---
title: "Gerrymandering in Alabama: Analysis Plan"
author: "Joseph Holler"
date: "`r Sys.Date()`"
output: html_document
editor_options:
  markdown:
    wrap: sentence
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../../docs") })
nocite: '@*'
bibliography: "../../software.bib"
---

# Abstract

This is a study of gerrymandering in Alabama.
We will test three methods of shape-based compactness scores, assess representativeness of districts based on prior presidential elections and race. 
We will then extend prior studies by calculating representativeness of the convex hull of district polygons.

## Study Metadata

- `Key words`: Alabama, gerrymandering, compactness, convex hull, political representation
- `Subject`: Social and Behavioral Sciences: Geography: Geographic Information Sciences
- `Date created`: 2025-02-17
- `Date modified`: 2025-02-17
- `Spatial Coverage`: Alabama OSM:[161950](https://www.openstreetmap.org/relation/161950)
- `Spatial Resolution`: Census Block Groups
- `Spatial Reference System`: EPSG:4269 NAD 1983 Geographic Coordinate System
- `Temporal Coverage`: 2020-2024 population and voting data
- `Temporal Resolution`: Decennial census

# Study design

This is an original study based on literature on gerrymandering metrics.

It is an exploratory study to evaluate usefulness of a new gerrymandering metric based on the convex hull of a congressional district and the representativeness inside the convex hull compared to the congressional district.

# Materials and procedure

## Computational environment

I plan on using package ... for ... 

```{r environment-setup, include = FALSE}
# record all the packages you are using here
# this includes any calls to library(), require(),
# and double colons such as here::i_am()
packages <- c("tidyverse",
              "here",
              "sf",
              "tmap",
              "tidycensus",
              "knitr", 
              "htmltools",
              "markdown")

# force all conflicts to become errors
# if you load dplyr and use filter(), R has to guess whether you mean dplyr::filter() or stats::filter()
# the conflicted package forces you to be explicit about this
# disable at your own peril
# https://conflicted.r-lib.org/
require(conflicted)

# load and install required packages
# https://groundhogr.com/
if (!require(groundhog)) {
  install.packages("groundhog")
  require(groundhog)
}

# this date will be used to determine the versions of R and your packages
# it is best practice to keep R and its packages up to date
groundhog.day <- "2025-02-01"

# this replaces any library() or require() calls
groundhog.library(packages, groundhog.day)
# you may need to install a correct version of R
# you may need to respond OK in the console to permit groundhog to install packages
# you may need to restart R and rerun this code to load installed packages
# In RStudio, restart r with Session -> Restart Session

# record the R processing environment
# alternatively, use devtools::session_info() for better results
writeLines(
  capture.output(sessionInfo()),
  here("procedure", "environment", paste0("r-environment-", Sys.Date(), ".txt"))
)

# save package citations
knitr::write_bib(c(packages, "base"), file = here("software.bib"))

# set up default knitr parameters
# https://yihui.org/knitr/options/
knitr::opts_chunk$set(
  echo = FALSE, # Run code, show outputs (don't show code)
  fig.retina = 4,
  fig.width = 8,
  fig.path = paste0(here("results", "figures"), "/")
)
```

## Data and variables

WE plan on using data sources .... , ... ....

### Precincts 2020

```{r}
includeMarkdown(here("data", "metadata", "precincts20.md"))
```


### Decennial Census

We acquire decennial census data in block groups using the `tidycensus` package.
First, query metadata for the `pl` public law data series.

```{r}
census_metadata_file <- here("data", "metadata", "census2020pl_vars.csv")
if(file.exists(census_metadata_file)){
  census2020pl_vars <- read.csv(census_metadata_file)
} else {
  census2020pl_vars <- load_variables(2020, "pl")
  write.csv(census2020pl_vars, here("data", "metadata", "census2020pl_vars.csv"))
}
```

The issue in the 2023 court cases on Alabama's gerrymandering was a racial gerrymander discriminating against people identifying as Black or African American.
Therefore, we will analyze people of voting age (18 or older) identifying as Black and or African as one race in any combination with other races.
This data is found in table `P3`.

Query the public law data series table P3 on "race for the population 18 years and over".

```{r message=FALSE, warning=FALSE}
blockgroup_file <- here("data", "raw", "public", "block_groups.gpkg")

# if the data is already downloaded, just load it
# otherwise, query from the census and save
if(file.exists(blockgroup_file)){
  blockgroups <- st_read(blockgroup_file)
} else {
  blockgroups <- get_decennial(geography = "block group",
                               sumfile = "pl",
                               table = "P3",
                               year = 2020,
                               state = "Alabama",
                               output = "wide",
                               geometry = TRUE,
                               keep_geo_vars = TRUE)
  st_write(blockgroups, blockgroup_file)
}
```
## Prior observations  

We have previously investigated the compactness scores of Alabama's congressional districts as well as the percentage of Biden voters from the 2020 elections and the percentage of the population 18 years or older that is not Hispanic and is Black or African American.

We have never calculated the minimum bounding circle or convex hulls of Alabama's congressional districts.

## Bias and threats to validity

This study is explicitly an investigation to the modifiable areal unit problem.
Aspects of the study are extremely sensitive to the combination of edge effects and scale, whereby complex borders formed by natural features, e.g. coastlines or rivers, vary greatly in perimeter depending on the scale of analysis. 
We hope that in part, this study establishes a method that is more robust (less sensitive) to the threats to validity caused by scale and edge effects in studies of gerrymandering and district shapes.

## Data transformations

Describe all data transformations planned to prepare data sources for analysis.
This section should explain with the fullest detail possible how to transform data from the **raw** state at the time of acquisition or observation, to the pre-processed **derived** state ready for the main analysis.
Including steps to check and mitigate sources of **bias** and **threats to validity**.
The method may anticipate **contingencies**, e.g. tests for normality and alternative decisions to make based on the results of the test.
More specifically, all the **geographic** and **variable** transformations required to prepare input data as described in the data and variables section above to match the study's spatio-temporal characteristics as described in the study metadata and study design sections.
Visual workflow diagrams may help communicate the methodology in this section.

Examples of **geographic** transformations include coordinate system transformations, aggregation, disaggregation, spatial interpolation, distance calculations, zonal statistics, etc.

Examples of **variable** transformations include standardization, normalization, constructed variables, imputation, classification, etc.

Be sure to include any steps planned to **exclude** observations with *missing* or *outlier* data, to **group** observations by *attribute* or *geographic* criteria, or to **impute** missing data or apply spatial or temporal **interpolation**.

### Calculate Census Variables

Sum the total of people identifying as Black or African American as one race or any combination of multiple races.
First, make a list of all the variables inclusive of people identifying as Black or African American.

```{r}
black_vars <- census2020pl_vars |> 
  dplyr::filter(str_detect(name, "P3"),
                str_detect(label, "Black")) |> 
  select(-concept)

black_vars |> kable()
```

Next, calculate new columns.
`Black` is a sum of all 32 columns shown above, in which any of the racial categories by which someone identifies is Black or African American.  
`Total` is a copy of the population 18 years or over, variable `P3_001N`.  
`PctBlack` is calculated as `Black / Total * 100`  
`CheckPct` is calculated as the percentage of the population 18 years or older that is either white of one race only (`P3_003N`) *or* Black or African American as calculated above. In Alabama, we can expect that this will be close to 100% for most block groups, and should never exceed 100%.

```{r, message=FALSE, warning=FALSE}
blockgroups_calc <- blockgroups |> 
  rowwise() |> 
  mutate(Black = sum(c_across(all_of(black_vars$name)))) |> 
  ungroup() |> 
  mutate(Total = P3_001N,
         PctBlack = Black / Total * 100,
         CheckPct = (Black + P3_003N) / Total * 100) |> 
  select(GEOID, Black, Total, PctBlack, CheckPct)
```
Save the results as blockgroups_calc.gpkg

```{r eval=FALSE}
st_write(blockgroups_calc, 
         here("data", "derived", "public", "blockgroups_calc.gpkg"),
         append=FALSE)
```
Map the percentage of the population 18 or over that is Black or African American.

```{r}
tm_shape(blockgroups_calc) + 
  tm_polygons(
    fill = "PctBlack",
    col_alpha = 0.2,
    lwd = 0.1,
    col = "grey90"
  )
```




## Analysis

Describe the methods of analysis that will directly test the hypotheses or provide results to answer the research questions.
This section should explicitly define any spatial / statistical *models* and their *parameters*, including *grouping* criteria, *weighting* criteria, and *significance thresholds*.
Also explain any follow-up analyses or validations.

# Results

Describe how results are to be presented.

# Discussion

Describe how the results are to be interpreted *vis a vis* each hypothesis or research question.

# Integrity Statement

Include an integrity statement - The authors of this preregistration state that they completed this preregistration to the best of their knowledge and that no other preregistration exists pertaining to the same hypotheses and research.
If a prior registration *does* exist, explain the rationale for revising the registration here.

# Acknowledgements

- `Funding Name`: name of funding for the project
- `Funding Title`: title of project grant
- `Award info URI`: web address for award information
- `Award number`: award number

This report is based upon the template for Reproducible and Replicable Research in Human-Environment and Geographical Sciences, DOI: [10.17605/OSF.IO/W29MQ](https://doi.org/10.17605/OSF.IO/W29MQ)

# References
